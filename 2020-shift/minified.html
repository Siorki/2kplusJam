<canvas id=a></canvas><script>
a=document.getElementById('a');c=a.getContext('2d');a.width=1024;a.height=512;c.font='30px arial';A=new AudioContext();B=A.createBuffer(1,2200,22050);C=B.getChannelData(0);for(i=0;i<2200;++i){C[i]=(i&50)/50-(i%80>40?1:0)}soundSource=A.createBufferSource();soundSource.buffer=B;soundSource.loop=true;soundSource.connect(A.destination);soundSource.start();soundSource.playbackRate.value=.01;I=c.getImageData(0,0,1024,512);D=I.data;level=0;raceStatus=3;v=[];setInterval(t=>{if(raceStatus>1){if(raceStatus>2){clouds=p=[];color=[];for(x=y=0;1024>y;y+=!(x=x+1&1023)){color.push(0);p.push(0)}for(t=b=0;++b-2e6;t=9*t+2+9*Math.cos(t)&-1){x+=[0,1,0,-1][t&3];y+=[0,1,0,-1][3-t&3];for(l=-4;++l-5;)for(m=-4;++m-5;)p[1024*(y+m&1023)+(x+l&1023)]+=.01}i=512}else{p=[];color=[];for(x=y=0;1024>y;y+=!(x=x+1&1023)){color.push(0);p.push(Math.min(1,52-55*Math.cos(x/160-Math.sin(y/160)))-1)}for(t=b=0;++b-5e6;t=9*t+2+9*Math.cos(t)&-1){x+=[0,1,0,-1][t&3];y+=[0,1,0,-1][3-t&3];v[t&3]=0;for(l=-4;++l-5;)for(m=-4;++m-5;)p[1024*(y+m&1023)+(x+l&1023)]+=.01}l=0;m=0;angle=0;refAlt=0;totalLength=4000,sectionLength=50,deltaAngle=0;while(--totalLength){x=0;y=0;refAlt=.95*refAlt+.05*p[1024*(y+m&1023)+(x+l&1023)];for(dj=-8;dj<9;++dj){x=dj*Math.sin(angle);y=-dj*Math.cos(angle);p[1024*(y+m&1023)+(x+l&1023)]=refAlt;color[1024*(y+m&1023)+(x+l&1023)]=(dj==-8||dj==8?(totalLength&16?2:3):(totalLength<128?4:1))}l+=.25*Math.cos(angle);m+=.25*Math.sin(angle);--sectionLength||(deltaAngle=Math.sin(l+level)/100,sectionLength=20+(m&63));angle+=deltaAngle}}l=10;m=0;s=q=C=0;pitch=0;timer=-100;--raceStatus;cloudCover=5+4*Math.sin(level+4*Math.cos(level));h=.2-1.5*Math.cos(level)}else{accel=raceStatus?v[0]-v[2]:.02;x=y=0;s=timer<0?0:s-accel/2-(color[1024*(y+m&1023)+(x+l&1023)]?.01:.06)*s*Math.abs(s);soundSource.playbackRate.value=timer<20?((timer+100)%50<20?(timer<0?1.6:3):.01):Math.max(.1,Math.abs(s));oldAlt=Math.max(0,p[1024*(y+m&1023)+(x+l&1023)]);if(4==color[1024*(y+m&1023)+(x+l&1023)]){raceStatus=0}l+=s*Math.cos(C=Math.atan2(Math.sin(C),Math.cos(C))+q);m+=s*Math.sin(C);q=q/2+Math.min(1,Math.max(-1,s*4))*(v[1]-v[3]);i=.9*i+10+5*Math.max(0,p[1024*(y+m&1023)+(x+l&1023)]);x=5*Math.cos(C);y=5*Math.sin(C);newAlt=Math.max(0,p[1024*(y+m&1023)+(x+l&1023)]);pitch=.9*pitch+.05*(oldAlt-newAlt);timer+=raceStatus}d=k=432*C-672*Math.sin(h+=1/4096);u=256-200*pitch+q*3*d-384*Math.cos(h);for(d=-512;512>d;d+=4){for(f=512,a=4*(1024*f-512+d),e=0;++e-300;){x=.5*e*Math.cos(C)+e*Math.sin(C)*d/800;y=-d/800*e*Math.cos(C)+e*Math.sin(C)/2;b=Math.max(0,p[1024*(y+m&1023)+(x+l&1023)]);w=Math.max(0,256-200*pitch+q*3*d-384*2*b/e+15*i/e);if(f>w){oneColor=color[1024*(y+m&1023)+(x+l&1023)];if(4==oneColor){oneColor=1+((x+l&2)^(y+m&2))}++y;dy=b-Math.max(0,p[1024*(y+m&1023)+(x+l&1023)]);--y;++x;dx=b-Math.max(0,p[1024*(y+m&1023)+(x+l&1023)]);dn=Math.sqrt(1-dx*dx-dy*dy);y=Math.max(0,Math.min(1,.2+Math.cos(h)))*Math.max(0,Math.min(1,(12-cloudCover)/16+cloudCover/5*dy*Math.sin(h)));y+=Math.cos(h)<.2?Math.max(y,Math.min(.6,Math.max(0,80+20*e-Math.abs(d))/(4*(x*x+y*y)+20))):0;t=e/300;x=[[b/5,3,1,(b>5?4:1.5)][level&3],2,3,3][oneColor]/4;r=y*255*(Math.max(0,Math.min(1,.5+2*Math.cos(h)))*t+(1-t)*x);x=[[b/15+3,2,2,(b>5?3:1)][level&3],2,0,3][oneColor]/4;g=y*255*(Math.max(0,Math.cos(h-.2))*t+(1-t)*x);x=[[b/5||4,1,b?1:3,(b>5?4:1)][level&3],2,0,3][oneColor]/4;b=y*255*((.2+.8*Math.max(0,Math.min(1,3*Math.cos(h+.5))))*t+(1-t)*x);for(++f;--f>w;a-=4112){D[a++]=r&255;D[a++]=g&255;D[a++]=b&255;D[a++]=255;D[a++]=r&255;D[a++]=g&255;D[a++]=b&255;D[a++]=255;D[a++]=r&255;D[a++]=g&255;D[a++]=b&255;D[a++]=255;D[a++]=r&255;D[a++]=g&255;D[a++]=b&255;D[a++]=255}}}for(++f;--f;a-=4112){r=55;g=118+112*Math.cos(h);b=55+200*Math.max(0,Math.min(1,4*Math.cos(h)));e=Math.sqrt((d-k)*(d-k)+(f-u)*(f-u));t=Math.max(0,Math.min(1,(e-35)/-10));x=255*Math.max(0,Math.cos(h));y=x*t+(1-t)*(55+200*Math.max(0,Math.cos(h)));x=(99+155*Math.sqrt(Math.max(0,Math.cos(h))))*t+(1-t)*x;t=Math.max(0,Math.min(1,(e-35)/256));r=r*t+(1-t)*255;g=g*t+(1-t)*x;b=b*t+(1-t)*y;e=40*512/(256-200*pitch+q*3*d-f);x=9*h+.5*e*Math.cos(C)+e*Math.sin(C)*d/800;y=-d/800*e*Math.cos(C)+e*Math.sin(C)/2;t=Math.min(1,Math.max(0,2*clouds[1024*(y+m&1023)+(x+l&1023)]-cloudCover,-t*(-200*pitch+q*3*d-f)/256));r=255*Math.max(0,Math.min(1,.5+2*Math.cos(h)))*t+(1-t)*r;g=255*Math.max(0,Math.cos(h-.2))*t+(1-t)*g;b=(55+200*Math.max(0,Math.min(1,3*Math.cos(h+.5))))*t+(1-t)*b;D[a++]=r&255;D[a++]=g&255;D[a++]=b&255;D[a++]=255;D[a++]=r&255;D[a++]=g&255;D[a++]=b&255;D[a++]=255;D[a++]=r&255;D[a++]=g&255;D[a++]=b&255;D[a++]=255;D[a++]=r&255;D[a++]=g&255;D[a++]=b&255;D[a++]=255}}c.putImageData(I,0,0);seconds=Math.floor(Math.max(0,timer)/50);c.textAlign='right';c.fillStyle=(timer<2000?'#000':'#f00');c.fillText(raceStatus>1?'0:40 to qualify':Math.floor(seconds/60)+':'+(seconds%60<10?0:'')+(seconds%60),1000,40);c.textAlign='left';c.fillText(raceStatus>1?'Track '+(1+level):(timer<0?'Get ready':(raceStatus?255*s|0:(timer>2000?'Try again':'Well done !'))),20,40);if(!raceStatus&&s<.01){raceStatus=3;timer>2000||++level}},20);onkeydown=t=>v[t.keyCode&3]=.01;onkeyup=t=>v[t.keyCode&3]=0</script>
